{% extends 'base.html' %}
{% load static %}

{% block title %}{{ job.title }} - JobPortal{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/jobs-detail.css' %}">
{% endblock %}

{% block content %}
<div class="job-detail-header">
    <div class="container">
        <div class="job-header-container">
            <div class="job-header-main">
                <h1 class="job-header-title">{{ job.title }}</h1>
                
                <div class="job-header-info">
                    <div class="job-info-item">
                        <div class="job-info-icon salary"><i class="fa-solid fa-money-bill-wave"></i></div>
                        <div class="job-info-content">
                            <span class="job-info-label">Mức lương</span>
                            <span class="job-info-value">
                                {% if job.salary_min and job.salary_max %}
                                    {{ job.salary_min }} - {{ job.salary_max }} triệu
                                {% elif job.salary_min %}
                                    Từ {{ job.salary_min }} triệu
                                {% elif job.salary_max %}
                                    Đến {{ job.salary_max }} triệu
                                {% else %}
                                    Thương lượng
                                {% endif %}
                            </span>
                        </div>
                    </div>
                    
                    <div class="job-info-item">
                        <div class="job-info-icon location"><i class="fa-solid fa-location-dot"></i></div>
                        <div class="job-info-content">
                            <span class="job-info-label">Địa điểm</span>
                            <span class="job-info-value">{{ job.location_short }}</span>
                        </div>
                    </div>
                    
                    <div class="job-info-item">
                        <div class="job-info-icon experience"><i class="fa-solid fa-star"></i></div>
                        <div class="job-info-content">
                            <span class="job-info-label">Kinh nghiệm</span>
                            <span class="job-info-value">{{ job.experience_level|default:"Không yêu cầu" }}</span>
                        </div>
                    </div>
                </div>
                
                <div class="job-deadline">
                    <i class="fa-regular fa-clock"></i> Hạn nộp hồ sơ: 
                    {% if job.expiration_date %}
                        <strong>{{ job.expiration_date|date:"d/m/Y" }}</strong>
                        <span class="job-deadline-days">Còn {{ job.expiration_date|timeuntil }}</span>
                    {% else %}
                        <strong>Đang tuyển</strong>
                    {% endif %}
                </div>
                
                <div class="job-header-actions">
                    {% if user.is_authenticated and not user.company %}
                        {% if user_applied %}
                        <button class="btn-apply-now" disabled>
                            Bạn đã ứng tuyển công việc này
                        </button>
                        {% else %}
                        <button class="btn-apply-now" onclick="document.getElementById('apply-modal').style.display='flex';">
                            Ứng tuyển ngay
                        </button>
                        {% endif %}
                    {% elif user.is_authenticated and user.company %}
                    <button class="btn-apply-now" disabled>
                        Bạn không thể ứng tuyển với tài khoản Nhà tuyển dụng
                    </button>
                    {% else %}
                    <a href="{% url 'accounts:login' %}" class="btn-apply-now">
                        Đăng nhập để ứng tuyển
                    </a>
                    {% endif %}
                    
                    <a href="{% url 'jobs:save' job.id %}" class="btn-save-job {% if user_saved %}saved{% endif %}">
                        {% if user_saved %}Đã lưu{% else %}Lưu tin{% endif %}
                    </a>
                </div>
            </div>
            
            <div class="job-header-sidebar">
                <div class="company-header">
                    <div class="company-logo-box">
                        {% if job.company.logo %}
                        <img src="{{ job.company.logo.url }}" alt="{{ job.company.name }}">
                        {% else %}
                        <span class="company-logo-placeholder">{{ job.company.name|first }}</span>
                        {% endif %}
                    </div>
                    <div class="company-header-info">
                        <h3>{{ job.company.name }}</h3>
                    </div>
                </div>
                
                <div class="company-detail-row">
                    <span class="company-detail-icon"><i class="fa-solid fa-users"></i></span>
                    <span class="company-detail-label">Quy mô:</span>
                    <span class="company-detail-value">{{ job.company.company_size|default:"Chưa cập nhật" }}</span>
                </div>
                
                <div class="company-detail-row">
                    <span class="company-detail-icon"><i class="fa-solid fa-building"></i></span>
                    <span class="company-detail-label">Lĩnh vực:</span>
                    <span class="company-detail-value">{{ job.category.name|default:"Chưa cập nhật" }}</span>
                </div>
                
                <div class="company-detail-row">
                    <span class="company-detail-icon"><i class="fa-solid fa-location-dot"></i></span>
                    <span class="company-detail-label">Địa điểm:</span>
                    <span class="company-detail-value">{{ job.location }}</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Main Content -->
<div class="container">
    <div class="detail-content">
        <div class="detail-main">
            <div class="detail-section">
                <h2 class="section-title">Mô tả công việc</h2>
                <div class="section-content">
                    {{ job.description|linebreaks }}
                </div>
            </div>

            {% if job.responsibilities %}
            <div class="detail-section">
                <h2 class="section-title">Trách nhiệm công việc</h2>
                <div class="section-content">
                    {{ job.responsibilities|linebreaks }}
                </div>
            </div>
            {% endif %}

            {% if job.requirements %}
            <div class="detail-section">
                <h2 class="section-title">Yêu cầu ứng viên</h2>
                <div class="section-content">
                    {{ job.requirements|linebreaks }}
                </div>
            </div>
            {% endif %}

            {% if job.required_skills.all %}
            <div class="detail-section">
                <h2 class="section-title">Kỹ năng yêu cầu</h2>
                <div class="skills-list">
                    {% for skill in job.required_skills.all %}
                    <span class="skill-tag">{{ skill.name }}</span>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Sidebar -->
        <div class="detail-sidebar">
            {% if matching_info and matching_info.has_profile %}
            <div class="sidebar-card matching-score-card">
                <h3><i class="fa-solid fa-chart-simple"></i> Mức độ phù hợp</h3>
                <div class="matching-score-value">
                    <div class="score">{{ matching_info.matching_score }}%</div>
                    <div class="label">Mức độ phù hợp với kỹ năng của bạn</div>
                </div>
                <div class="matching-score-breakdown">
                    <div class="item">
                        <div class="value">{{ matching_info.skill_score }}%</div>
                        <div class="label">Kỹ năng</div>
                    </div>
                    <div class="item">
                        <div class="value">{{ matching_info.text_score }}%</div>
                        <div class="label">Nội dung</div>
                    </div>
                </div>
                {% if matching_info.matched_skills %}
                <div class="matched-skills-section">
                    <div class="title"><i class="fa-solid fa-circle-check"></i> Kỹ năng trùng khớp:</div>
                    <div class="matched-skills-list">
                        {% for skill in matching_info.matched_skills %}
                        <span class="skill">{{ skill.name }}</span>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
            {% elif user.is_authenticated %}
            <div class="sidebar-card update-profile-card">
                <h3><i class="fa-solid fa-chart-simple"></i> Điểm phù hợp</h3>
                <p>
                    <i class="fa-solid fa-lightbulb"></i> Cập nhật hồ sơ kỹ năng để xem điểm phù hợp với công việc này!
                </p>
                <a href="{% url 'accounts:skill_profile' %}" class="btn btn-primary" style="width: 100%; display: block; text-align: center;">
                    <i class="fa-solid fa-pen-to-square"></i> Cập nhật kỹ năng
                </a>
            </div>
            {% endif %}

            <div class="sidebar-card">
                <h3>Thông tin chung</h3>
                <div class="job-posted-info">
                    <p><strong>Loại công việc:</strong> {{ job.job_type }}</p>
                    <p><strong>Địa điểm:</strong> {{ job.location_short }}</p>
                    <p><strong>Kinh nghiệm:</strong> {{ job.experience_level|default:"Không yêu cầu" }}</p>
                    <p><strong>Đăng ngày:</strong> {{ job.created_at|date:"d/m/Y" }}</p>
                    <p><strong>Số ứng viên:</strong> {{ job.applicants.count }}</p>
                </div>
            </div>

            {% if job.expiration_date %}
            <div class="sidebar-card deadline-card">
                <p>
                    <i class="fa-regular fa-clock"></i> Hạn nộp: {{ job.expiration_date|date:"d/m/Y" }}
                </p>
            </div>
            {% endif %}
        </div>
    </div>
    
    {% if related_jobs %}
    <div class="related-jobs-section">
        <h2 class="related-jobs-title">
            Việc làm khác tại {{ job.province.name|default:"cùng khu vực" }}
        </h2>
        <div class="related-jobs-grid">
            {% for rjob in related_jobs %}
            <a href="{% url 'jobs:detail' rjob.id %}" class="related-job-card">
                <div class="related-job-title">{{ rjob.title }}</div>
                <div class="related-job-company">{{ rjob.company.name }}</div>
                <div class="related-job-meta">
                    <span class="related-job-salary">
                        {% if rjob.salary_min and rjob.salary_max %}
                            {{ rjob.salary_min }}-{{ rjob.salary_max }}tr
                        {% else %}
                            Thương lượng
                        {% endif %}
                    </span>
                    <span><i class="fa-solid fa-location-dot"></i> {{ rjob.location_short }}</span>
                </div>
            </a>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

<!-- Apply Modal -->
<div id="apply-modal" class="apply-modal-overlay">
    <div class="apply-modal-content">
        <h2>Ứng tuyển: {{ job.title }}</h2>

        <form method="POST" action="{% url 'jobs:apply' job.id %}" enctype="multipart/form-data">
            {% csrf_token %}

            <div class="apply-form-row">
                <div class="form-group">
                    <label>Họ và tên <span style="color: #ef4444;">*</span></label>
                    <input type="text" name="full_name" required placeholder="Nhập họ tên đầy đủ"
                        value="{{ user.get_full_name }}">
                </div>
                <div class="form-group">
                    <label>Số điện thoại <span style="color: #ef4444;">*</span></label>
                    <input type="text" name="phone" required placeholder="Số điện thoại liên hệ">
                </div>
            </div>

            <div class="form-group">
                <label>Email <span style="color: #ef4444;">*</span></label>
                <input type="email" name="email" required placeholder="Email của bạn" value="{{ user.email }}">
            </div>

            <div class="apply-form-row">
                <div class="form-group">
                    <label>Ảnh cá nhân</label>
                    <input type="file" name="photo" accept="image/*" style="padding: 8px;">
                    <small style="color: #64748b; display: block; margin-top: 5px;">JPG, PNG (max 2MB)</small>
                </div>
                <div class="form-group">
                    <label>CV/Resume <span style="color: #ef4444;">*</span></label>
                    <input type="file" name="cv_file" accept=".pdf,.doc,.docx" required style="padding: 8px;">
                    <small style="color: #64748b; display: block; margin-top: 5px;">PDF, DOC, DOCX</small>
                </div>
            </div>

            <div class="form-group">
                <label>Giới thiệu bản thân <span style="color: #ef4444;">*</span></label>
                <textarea name="introduction" required
                    placeholder="Giới thiệu ngắn về bản thân và kinh nghiệm của bạn..." rows="3">{{ user_bio }}</textarea>
            </div>

            <div class="form-group">
                <label>Thư xin việc</label>
                <textarea name="cover_letter" placeholder="Tại sao bạn phù hợp với vị trí này..."
                    rows="4"></textarea>
            </div>

            <div class="apply-form-actions">
                <button type="submit" class="btn btn-primary">
                    <i class="fa-solid fa-paper-plane"></i> Nộp đơn ứng tuyển
                </button>
                <button type="button" class="btn btn-secondary"
                    onclick="document.getElementById('apply-modal').style.display='none'">Hủy</button>
            </div>
        </form>
    </div>
</div>

<script>
    document.addEventListener('click', function (event) {
        const modal = document.getElementById('apply-modal');
        if (event.target === modal) {
            modal.style.display = 'none';
        }
    });
</script>
{% endblock %}