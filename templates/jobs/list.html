{% extends 'base.html' %}
{% load static %}
{% load job_extras %}

{% block title %}Việc làm - JobNow{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/jobs-list.css' %}">
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header">
    <div class="container">
        <h1>Tìm việc làm</h1>
        <p>Tìm thấy {{ jobs_count }} việc làm phù hợp</p>
    </div>
</div>

<div class="container">
    <div class="top-filter-bar">
        <div class="filter-bar-left">
            <div class="filter-bar-label">
                Lọc nhanh
            </div>
            <form method="GET" id="topFilterForm" class="top-filter-form">
                <input type="hidden" name="q" value="{{ search_query }}">
                {% for cat in selected_categories %}
                    <input type="hidden" name="category" value="{{ cat }}">
                {% endfor %}
                {% for exp in selected_experience %}
                    <input type="hidden" name="experience" value="{{ exp }}">
                {% endfor %}
                {% for jt in selected_job_types %}
                    <input type="hidden" name="job_type" value="{{ jt }}">
                {% endfor %}
                {% for pv in selected_provinces %}
                    <input type="hidden" name="provinces" value="{{ pv }}">
                {% endfor %}
                {% if salary_min %}
                    <input type="hidden" name="salary_min" value="{{ salary_min }}">
                {% endif %}
                {% if salary_max %}
                    <input type="hidden" name="salary_max" value="{{ salary_max }}">
                {% endif %}
                
                <select name="sort" class="filter-select" onchange="this.form.submit()">
                    {% if has_skill_profile %}
                    <option value="matching" {% if sort_by == 'matching' %}selected{% endif %}>Điểm phù hợp</option>
                    {% endif %}
                    <option value="newest" {% if sort_by == 'newest' %}selected{% endif %}>Mới nhất</option>
                    <option value="oldest" {% if sort_by == 'oldest' %}selected{% endif %}>Cũ nhất</option>
                    <option value="salary_high" {% if sort_by == 'salary_high' %}selected{% endif %}>Lương cao nhất</option>
                    <option value="city" {% if sort_by == 'city' %}selected{% endif %}>Theo thành phố</option>
                </select>

                <select name="province_filter" class="filter-select" onchange="this.form.submit()">
                    <option value="">Tất cả Tỉnh/TP</option>
                    {% for province in provinces %}
                        <option value="{{ province.code }}" {% if province.code == province_filter %}selected{% endif %}>
                            {{ province.name }}
                        </option>
                    {% endfor %}
                </select>
            </form>
        </div>
        <div class="filter-bar-right">
            <div class="results-count">
                {{ jobs_count }} việc làm
            </div>
        </div>
    </div>

    <div class="jobs-container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h3>Lọc nâng cao</h3>
            </div>
            
            <form method="GET" class="filter-form" id="sidebarFilterForm">
                <input type="hidden" name="sort" value="{{ sort_by }}">
                {% if city_filter %}
                    <input type="hidden" name="city_filter" value="{{ city_filter }}">
                {% endif %}
                
                <div class="search-box sidebar-section">
                    <input type="text" name="q" placeholder="Tìm kiếm từ khóa..." value="{{ search_query }}">
                </div>
                <div class="sidebar-section">
                    <div class="sidebar-title">Danh mục nghề</div>
                    <div class="section-collapsible">
                        {% for category in categories %}
                        <div class="filter-group">
                            <label>
                                <input type="checkbox" name="category" value="{{ category.id }}" 
                                    {% if category.id|stringformat:"s" in selected_categories %}checked{% endif %}>
                                {{ category.name }}
                            </label>
                        </div>
                        {% empty %}
                        <p style="color: var(--text-light); font-size: 13px;">Chưa có danh mục</p>
                        {% endfor %}
                    </div>
                </div>

                <div class="sidebar-section">
                    <div class="sidebar-title">Kinh nghiệm</div>
                    <div class="section-collapsible">
                        {% for exp in experience_options %}
                        <div class="filter-group">
                            <label>
                                <input type="checkbox" name="experience" value="{{ exp.name }}"
                                    {% if exp.name in selected_experience %}checked{% endif %}>
                                {{ exp.name }}
                            </label>
                        </div>
                        {% empty %}
                        <p style="color: var(--text-light); font-size: 13px;">Chưa có dữ liệu</p>
                        {% endfor %}
                    </div>
                </div>

                <div class="sidebar-section">
                    <div class="sidebar-title">Mức lương (triệu VNĐ)</div>
                    <div class="salary-range-inputs">
                        <input type="number" name="salary_min" class="salary-input" 
                            placeholder="Từ" value="{{ salary_min }}" min="0">
                        <span class="salary-separator">-</span>
                        <input type="number" name="salary_max" class="salary-input" 
                            placeholder="Đến" value="{{ salary_max }}" min="0">
                    </div>
                </div>

                <div class="sidebar-section">
                    <div class="sidebar-title">Hình thức làm việc</div>
                    <div class="section-collapsible">
                        {% for job_type_value, job_type_label in job_type_options %}
                        <div class="filter-group">
                            <label>
                                <input type="checkbox" name="job_type" value="{{ job_type_value }}"
                                    {% if job_type_value in selected_job_types %}checked{% endif %}>
                                {% if job_type_value == 'Full Time' %}
                                {% elif job_type_value == 'Part Time' %}
                                {% elif job_type_value == 'Contract' %} 
                                {% elif job_type_value == 'Remote' %} 
                                {% else %} 
                                {% endif %}{{ job_type_label }}
                            </label>
                        </div>
                        {% empty %}
                        <p style="color: var(--text-light); font-size: 13px;">Chưa có dữ liệu</p>
                        {% endfor %}
                    </div>
                </div>

                <div class="filter-buttons">
                    <button type="submit" class="btn-apply-filter">
                        Áp dụng bộ lọc
                    </button>
                    <a href="{% url 'jobs:list' %}" class="filter-reset">
                        Xóa tất cả bộ lọc
                    </a>
                </div>
            </form>
        </aside>

        <!-- Jobs List -->
        <div class="jobs-list-wrapper">
            {% if selected_categories or selected_experience or selected_job_types or salary_min or salary_max or search_query %}
            <div class="active-filters">
                {% if search_query %}
                    <span class="active-filter-tag">Từ khóa: {{ search_query }}</span>
                {% endif %}
                {% for cat in selected_categories %}
                    <span class="active-filter-tag">{{ cat }}</span>
                {% endfor %}
                {% for exp in selected_experience %}
                    <span class="active-filter-tag">{{ exp }}</span>
                {% endfor %}
                {% for jt in selected_job_types %}
                    <span class="active-filter-tag">{{ jt }}</span>
                {% endfor %}
                {% if salary_min %}
                    <span class="active-filter-tag">Từ {{ salary_min }}tr</span>
                {% endif %}
                {% if salary_max %}
                    <span class="active-filter-tag">Đến {{ salary_max }}tr</span>
                {% endif %}
            </div>
            {% endif %}

            {% if jobs %}
                <div class="jobs-list">
                    {% for job in jobs %}
                    <div class="job-item">
                        {% if has_skill_profile and job.id in matching_scores %}
                        {% with score=matching_scores|get_item:job.id %}
                        <div style="margin-bottom: 10px;">
                            <div style="background: linear-gradient(135deg, #1a8a7a 0%, #0f5f54 100%); color: white; padding: 6px 12px; border-radius: 20px; font-size: 13px; font-weight: 600; display: inline-flex; align-items: center; gap: 5px;">
                                Mức độ phù hợp {{ score.matching_score }}%
                            </div>
                        </div>
                        {% endwith %}
                        {% endif %}
                        
                        <div class="job-header" style="display: flex; gap: 15px;">
                            {% if job.company.logo %}
                            <div style="width: 60px; height: 60px; border-radius: 10px; overflow: hidden; flex-shrink: 0; border: 1px solid #e2e8f0;">
                                <img src="{{ job.company.logo.url }}" alt="{{ job.company.name }}" style="width: 100%; height: 100%; object-fit: cover;">
                            </div>
                            {% else %}
                            <div style="width: 60px; height: 60px; border-radius: 10px; background: linear-gradient(135deg, #1a8a7a 0%, #0f5f54 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 22px; font-weight: bold; flex-shrink: 0;">
                                {{ job.company.name|slice:":1"|upper }}
                            </div>
                            {% endif %}
                            
                            <div style="flex: 1; min-width: 0;">
                                <div class="job-title-company">
                                    <div class="job-title">{{ job.title }}</div>
                                    <div class="job-company">{{ job.company.name }}</div>
                                </div>
                            </div>
                            
                            <div style="display: flex; align-items: center; gap: 12px; flex-shrink: 0;">
                                <div class="job-salary">
                                    {% if job.salary_min and job.salary_max %}
                                        {{ job.salary_min }}tr - {{ job.salary_max }}tr VNĐ
                                    {% elif job.salary_min %}
                                        Từ {{ job.salary_min }}tr VNĐ
                                    {% elif job.salary_max %}
                                        Đến {{ job.salary_max }}tr VNĐ
                                    {% else %}
                                        Thương lượng
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="job-meta">
                            <div class="job-meta-item">{{ job.location_short }}</div>
                            <div class="job-meta-item">{{ job.job_type }}</div>
                            {% if job.experience_level %}
                            <div class="job-meta-item">{{ job.experience_level }}</div>
                            {% endif %}
                            {% if job.category %}
                            <div class="job-meta-item">{{ job.category.name }}</div>
                            {% endif %}
                            <div class="job-meta-item">{{ job.created_at|timesince }} trước</div>
                        </div>

                        <div class="job-description">
                            {{ job.description|truncatewords:30 }}
                        </div>

                        {% if job.required_skills.all %}
                        <div class="job-tags">
                            {% for skill in job.required_skills.all|slice:":5" %}
                                <span class="tag">{{ skill.name }}</span>
                            {% endfor %}
                        </div>
                        {% endif %}

                        <div class="job-footer">
                            <div class="job-posted">
                                {{ job.applicants.count }} ứng viên đã ứng tuyển
                            </div>
                            <div class="job-action">
                                <a href="{% url 'jobs:detail' job.id %}" class="btn-view">Xem chi tiết</a>
                                {% if user.is_authenticated %}
                                    <a href="{% url 'jobs:save' job.id %}" class="btn-save {% if job.id in saved_job_ids %}saved{% endif %}">
                                        {% if job.id in saved_job_ids %}Đã lưu{% else %}Lưu tin{% endif %}
                                    </a>
                                {% else %}
                                    <a href="{% url 'accounts:login' %}" class="btn-save">Lưu tin</a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="no-jobs">
                    <p>Không tìm thấy việc làm phù hợp với tiêu chí của bạn.</p>
                    <a href="{% url 'jobs:list' %}" class="btn btn-primary">Xóa bộ lọc</a>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}